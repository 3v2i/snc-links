name: Catastro expediente daily backup

on:
  schedule:
    - cron: "20 3 * * *"   # todos los días 03:20 UTC
  workflow_dispatch:

permissions:
  contents: write

jobs:
  backup:
    runs-on: ubuntu-latest

    steps:
      - name: Force Cloudflare DNS
        run: |
          sudo rm -f /etc/resolv.conf
          echo "nameserver 1.1.1.1" | sudo tee /etc/resolv.conf
          echo "nameserver 1.0.0.1" | sudo tee -a /etc/resolv.conf

      - name: Prepare workspace
        run: |
          mkdir work
          echo "DATE=$(date +%F)" >> $GITHUB_ENV
          echo "TS=$(date -u +%FT%TZ)" >> $GITHUB_ENV

      - name: Download expediente JSON
        run: |
          set -e

          EXPEDIENTE="232781"
          ANHO="2025"

          URLS=(
            "https://www.catastro.gov.py/expediente-electronico/api/public/consultas-publicas/cuenta-corriente?filters=%7B%22pisoNivel%22:%2200%22,%22dptoSalon%22:%22000%22,%22zona%22:27,%22manzana%22:3297,%22lote%22:12,%22idDepartamento%22:%22L%22,%22idCiudad%22:7%7D"
            "https://www.catastro.gov.py/expediente-electronico/api/public/consultas-publicas/expediente?filters=%7B%22anho%22:${ANHO},%22numeroExpediente%22:${EXPEDIENTE}%7D"
            "https://www.catastro.gov.py/expediente-electronico/api/public/consultas-publicas/movimiento-expediente?filters=%7B%22anho%22:${ANHO},%22numeroExpediente%22:${EXPEDIENTE}%7D"
          )

          echo "[]" > work/manifest.json

          for url in "${URLS[@]}"; do
            id=$(echo "$url" | sed -n 's/.*consultas-publicas\/\([^?]*\).*/\1/p')
            file="work/$id.json"

            curl -fsSL "$url" -o "$file"

            sha256=$(sha256sum "$file" | awk '{print $1}')

            jq \
              --arg id "$id" \
              --arg url "$url" \
              --arg expediente "$EXPEDIENTE" \
              --arg anho "$ANHO" \
              --arg sha "$sha256" \
              --arg timestamp "$TS" \
              '. += [{
                id: $id,
                expediente: $expediente,
                anho: $anho,
                url: $url,
                sha256: $sha,
                timestamp_utc: $timestamp
              }]' \
              work/manifest.json > work/tmp.json

            mv work/tmp.json work/manifest.json
          done

      - name: Import GPG key
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          printf "%s\n" "$GPG_PRIVATE_KEY" | gpg --batch --import

      - name: Sign manifest
        run: |
          gpg --batch --yes --armor --detach-sign work/manifest.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: backup-${{ env.DATE }}
          name: Catastro expediente backup ${{ env.DATE }}
          body: |
            Backup automático diario de APIs públicas del Catastro.
            Expediente: 232781 / Año: 2025
            Resolución DNS forzada a Cloudflare (1.1.1.1).
            Manifest JSON firmado con clave técnica GPG.
          files: |
            work/*.json
            work/manifest.json.asc
